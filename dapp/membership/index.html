<html>
<head>


    <script src="web3.min.js"></script>
    
    <script type="text/javascript">
        var ABI = [
    {
      "constant": false,
      "inputs": [],
      "name": "unpause",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [],
      "name": "paused",
      "outputs": [
        {
          "name": "",
          "type": "bool"
        }
      ],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [],
      "name": "renounceOwnership",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [],
      "name": "pause",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [],
      "name": "owner",
      "outputs": [
        {
          "name": "",
          "type": "factoryAddress"
        }
      ],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "_newOwner",
          "type": "factoryAddress"
        }
      ],
      "name": "transferOwnership",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [],
      "name": "token",
      "outputs": [
        {
          "name": "",
          "type": "factoryAddress"
        }
      ],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "name": "_tokenfactoryAddress",
          "type": "factoryAddress"
        },
        {
          "name": "companyWallet",
          "type": "factoryAddress"
        }
      ],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "name": "stake",
          "type": "factoryAddress"
        },
        {
          "indexed": false,
          "name": "beneficiary",
          "type": "factoryAddress"
        },
        {
          "indexed": false,
          "name": "lockPeriod",
          "type": "uint256"
        },
        {
          "indexed": false,
          "name": "atStake",
          "type": "uint256"
        }
      ],
      "name": "StakeCreated",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [],
      "name": "Pause",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [],
      "name": "Unpause",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "name": "previousOwner",
          "type": "factoryAddress"
        }
      ],
      "name": "OwnershipRenounced",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "name": "previousOwner",
          "type": "factoryAddress"
        },
        {
          "indexed": true,
          "name": "newOwner",
          "type": "factoryAddress"
        }
      ],
      "name": "OwnershipTransferred",
      "type": "event"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "lockPeriod",
          "type": "uint256"
        },
        {
          "name": "atStake",
          "type": "uint256"
        }
      ],
      "name": "createStake",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [],
      "name": "dismiss",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ];


  const erc20ABI=[
    {
        "constant": true,
        "inputs": [],
        "name": "name",
        "outputs": [
            {
                "name": "",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_spender",
                "type": "address"
            },
            {
                "name": "_value",
                "type": "uint256"
            }
        ],
        "name": "approve",
        "outputs": [
            {
                "name": "",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "totalSupply",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_from",
                "type": "address"
            },
            {
                "name": "_to",
                "type": "address"
            },
            {
                "name": "_value",
                "type": "uint256"
            }
        ],
        "name": "transferFrom",
        "outputs": [
            {
                "name": "",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "decimals",
        "outputs": [
            {
                "name": "",
                "type": "uint8"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "_owner",
                "type": "address"
            }
        ],
        "name": "balanceOf",
        "outputs": [
            {
                "name": "balance",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "symbol",
        "outputs": [
            {
                "name": "",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_to",
                "type": "address"
            },
            {
                "name": "_value",
                "type": "uint256"
            }
        ],
        "name": "transfer",
        "outputs": [
            {
                "name": "",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "_owner",
                "type": "address"
            },
            {
                "name": "_spender",
                "type": "address"
            }
        ],
        "name": "allowance",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "payable": true,
        "stateMutability": "payable",
        "type": "fallback"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "owner",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "spender",
                "type": "address"
            },
            {
                "indexed": false,
                "name": "value",
                "type": "uint256"
            }
        ],
        "name": "Approval",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "from",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "to",
                "type": "address"
            },
            {
                "indexed": false,
                "name": "value",
                "type": "uint256"
            }
        ],
        "name": "Transfer",
        "type": "event"
    }
];

        const factoryAddress = "0x4bd1cc20e97cbaa12365078cf292ef17d105860b";
        const StakeFactoryContract =web3.eth.contract(ABI);
        const factory     = StakeFactoryContract.at(factoryAddress);
        const VALORAddress = "0x6e748fe8f1f344ce557bfdbf29c085aa0dff73b9";
        const VALORContract = web3.eth.contract(erc20ABI);
        const VALOR     = VALORContract.at(VALORAddress);


        function approve(){
            var atStake = el("atStake").value;
            VALOR.approve(  factoryAddress,
							    atStake, 
					        {gas : 50000},
					        function(err,tx){
					            if(err) {
					                console.log(err);
					                alert(err);
					            } else{
                          el("approve-tx").innerHTML = tx;
					            }
					        });
        }

        function createStake(){
            var atStake = el("atStake").value;
            var event = factory.StakeCreated();
            factory.createStake(3600,
            					          atStake, 
                                { gas : 500000},
                                function(err,tx){
                                    if(err) {
                                        console.log(err);
                                        alert(err);
                                    } else{
                                        console.log(tx);
                                        el("lock-tx").innerHTML = tx;
                                    
                                    }
                                });


        }


        function decodeLogs(txRcpt){
          const inputs = [{
              type: 'address',
              name: 'stake'
          },{
              type: 'address',
              name: 'beneficiary'
          },{
              type: 'uint256',
              name: 'locktime',

          },{
              type: 'uint256',
              name: 'amount',
          }]; 

          const data = txRcpt.logs[1].data;
          const topics = txRcpt.logs[1].topics;
          const parsed = web3.eth.abi.decodeLog(inputs,data,topics);
          console.log(JSON.stringify(parsed));
          return parsed;
        }

            
        function updateInfoView(){
          el("info").innerHTML = "";
          addLine("web3.version.api",web3.version);
          addLine("contract factoryAddress",factoryAddress);
          // accounts = web3.eth.accounts;
          web3.eth.getAccounts(function (error, accounts) {
              if (accounts.length > 0) {
                  var account = accounts[0];
                  addLine("Your account", account);              
                  web3.eth.getBalance(account, function (err, wei) {
                      var balance = wei.toString();
                      addLine("ETH balance", balance);
                  });

                  VALOR.balanceOf(account,function(err,balance){
                    addLine("VALOR balance", balance);
                  });
              }
          });              
        }    



        function updateApproveView(){
          let approve_tx = el("approve-tx").innerHTML;
          if(approve_tx.length !== 0)
              web3.eth.getTransaction(approve_tx,function(er,tx){
                  if(tx.blockNumber !== null){
                    el("approve-tx-status").innerHTML = "confirmed";
                    el("lockButton").disabled = false;
                    el("approveButton").disabled = true;
                    
                  }
                  else  el("approve-tx-status").innerHTML = "pending";
          });

        }
            


        function updateLockView(){
          let lock_tx = el("lock-tx").innerHTML;
          if(lock_tx.length !== 0)
              web3.eth.getTransaction(lock_tx,function(er,tx){
                  if(tx.blockNumber !== null){
                    el("lock-tx-status").innerHTML = "confirmed";
                   
                    el("lockButton").disabled = true;
                    el("approveButton").disabled = true;
                    
                  }
                  else  el("lock-tx-status").innerHTML = "pending";

          });

        }


        function updateStakeView(){
          let lock_tx = el("lock-tx").innerHTML;
          if(lock_tx.length !== 0)
              web3.eth.getTransactionReceipt(lock_tx,function(er,rcpt){
                if(rcpt.blockNumber !== null){
                  stake = decodeLogs(rcpt);
                  el("stake-stake").innerHTML=stake.stake;
                  el("stake-beneficiary").innerHTML=stake.beneficiary;
                  el("stake-locktime").innerHTML=stake.locktime;
                  el("stake-amount").innerHTML=stake.amount;
              }});
        }

        function updateView(){
        	console.log("*** updateView ***");

          updateInfoView();
          updateApproveView();
          updateLockView();
          updateStakeView();

          
        }
		 

            
                
 
                    
        

        function addLine(label, value) {
            var p = document.createElement('p');
            p.textContent = label.toString() + ": " + value.toString();
            el("info").appendChild(p);
        }



        function el(elementID){
            return document.getElementById(elementID);
        }

        function testETH() {
            if (typeof web3 !== 'undefined') {
                var network = web3.version.getNetwork(function (err, netId) {
                    switch (netId) {
                        case "1":
                            netname = 'Main net';
                            break;
                        case "2":
                            netname = 'Morden test (deprecated)';
                            break;
                        case "3":
                            netname = 'Ropsten test';
                            break;
                        case "4":
                            netname = 'Rinkeby test';
                            break;
                        case "42":
                            netname = 'Kovan test';
                            break;
                        default:
                            netname = 'unknown network';
                    }
                    addLine("Network", netId+"."+netname);
                });

                if (window.web3) {
                  // Then replace the old injected version by the latest build of Web3.js version 1.0.0
                  window.web3 = new Web3(window.web3.currentProvider);
                }
                
                updateView();
                web3.currentProvider.publicConfigStore.on('update',updateView);

        }
      }

    </script>
</head>
<body onload="testETH()">
<h1>Create Stake Basic Dapp</h1>
<div>
    <input type="text" id="atStake" placeholder="insert token amount, eg. 10000000 ..."/><br/>
    <button  id="approveButton" onclick="approve();">Preapprove</button>
	<button id="lockButton" disabled onclick="createStake();">Lock Funds</button>
   
</div>

<h2>Approve tx</h2>
<div id="approve">
  <span id="approve-tx"></span>-----<span id="approve-tx-status"></span>

</div>
<h2>Lock tx</h2>
<div id="lock">
  <span id="lock-tx"></span>-----<span id="lock-tx-status"></span>

</div>
<h2>Stake</h2>
<div id="stake">
  stake address:
  <p id="stake-stake"></p>
  stake beneficiary:
  <p id="stake-beneficiary"></p>
  stake amount:
  <p id="stake-amount"></p>
  stake locktime:
  <p id="stake-locktime"></p>

</div>


<h2>Other info</h2>
<div id="info"></div>
</body>
</html>